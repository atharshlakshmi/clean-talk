name: Deploy to Google Cloud

on:
  push:
    branches: [ main ]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  API_IMAGE_NAME: backend
  APP_IMAGE_NAME: frontend

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Lint with flake8
      run: |
        pip install flake8
        flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics || true
    
    - name: Build Docker images for testing
      run: |
        docker build -f Dockerfile.api -t backend:test .
        docker build -f Dockerfile.app -t frontend:test .

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
    
    - name: Build and push API image
      run: |
        docker build -f Dockerfile.api \
          -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.API_IMAGE_NAME }}:latest \
          -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.API_IMAGE_NAME }}:${{ github.sha }} \
          .
        
        docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.API_IMAGE_NAME }}:latest
        docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.API_IMAGE_NAME }}:${{ github.sha }}
    
    - name: Build and push App image
      run: |
        docker build -f Dockerfile.app \
          -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.APP_IMAGE_NAME }}:latest \
          -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.APP_IMAGE_NAME }}:${{ github.sha }} \
          .
        
        docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.APP_IMAGE_NAME }}:latest
        docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.APP_IMAGE_NAME }}:${{ github.sha }}
    
    - name: Deploy API to Cloud Run
      run: |
        gcloud run deploy clean-talk-api \
          --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.API_IMAGE_NAME }}:latest \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --port 8000 \
          --env-vars-file=.env.cloud \
          --project=${{ env.GCP_PROJECT_ID }}
    
    - name: Deploy App to Cloud Run
      run: |
        gcloud run deploy clean-talk-app \
          --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/clean-talk/${{ env.APP_IMAGE_NAME }}:latest \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --port 8501 \
          --set-env-vars BACKEND_URL=https://clean-talk-api-<your-project-hash>.run.app \
          --project=${{ env.GCP_PROJECT_ID }}
    
    - name: Output deployment URLs
      run: |
        echo "API deployed to: https://clean-talk-api-$(gcloud run services describe clean-talk-api --region ${{ env.GCP_REGION }} --format 'value(status.url)' --project=${{ env.GCP_PROJECT_ID }})"
        echo "App deployed to: https://clean-talk-app-$(gcloud run services describe clean-talk-app --region ${{ env.GCP_REGION }} --format 'value(status.url)' --project=${{ env.GCP_PROJECT_ID }})"
